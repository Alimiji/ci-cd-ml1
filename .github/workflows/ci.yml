name: CI - Train & Validate Model

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:  # possibilité de lancer un entraînement manuel

jobs:
  train-ml:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout
      - name: Récupérer le code
        uses: actions/checkout@v4

      # 2) Python
      - name: Installer Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # 3) Install requirements
      - name: Installer les dépendances
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc mlflow

      # 4) Pull DVC data (dataset versionné)
      - name: Télécharger les données DVC
        run: dvc pull

      # 5) Entraîner le modèle
      - name: Entraîner le modèle
        run: |
          dvc repro  # ou "python train.py"

      # 6) Stocker le modèle entraîné comme artifact GitHub
      - name: Sauvegarder le modèle entraîné
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: models/  # adapte au dossier de ton modèle

      # 7) Tests unitaires
      - name: Lancer les tests
        run: pytest -q
