name: CD - Déploiement API ML sur Render

on:
  push:
    branches:
      - main          # Déploiement automatique quand tu merges sur main
    tags:
      - "v*"          # OU quand tu crées un tag de version (v1.0.0, v2, etc.)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Récupérer le code
      - name: Récupérer le code
        uses: actions/checkout@v4

      # 2) Se connecter au registre Docker (Docker Hub, GHCR, etc.)
      # Assure-toi d'avoir défini DOCKER_USERNAME et DOCKER_PASSWORD dans Settings > Secrets and variables > Actions
      - name: Connexion au registre Docker
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # 3) Construire l'image Docker de l'API ML
      - name: Construire l'image Docker
        run: |
          IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/ml-api
          GIT_SHORT_SHA=${GITHUB_SHA::7}
          echo "Construction de l'image : $IMAGE_NAME:latest et $IMAGE_NAME:$GIT_SHORT_SHA"
          docker build -t $IMAGE_NAME:latest -t $IMAGE_NAME:$GIT_SHORT_SHA .

      # 4) Pousser l'image vers le registre
      - name: Pousser l'image Docker
        run: |
          IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/ml-api
          GIT_SHORT_SHA=${GITHUB_SHA::7}
          docker push $IMAGE_NAME:latest
          docker push $IMAGE_NAME:$GIT_SHORT_SHA

      # 5) Déclencher le déploiement sur Render
      # Tu peux utiliser soit un "deploy hook URL" (le plus simple), soit l'API Render avec token.
      # Ici : version simple avec un hook.
      - name: Déclencher le déploiement Render
        run: |
          echo "Déclenchement du déploiement sur Render..."
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
