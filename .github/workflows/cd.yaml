name: CD - Déploiement API avec modèle ML

on:
  push:
    tags:
      - "v*"   # Déploiement uniquement lors d'une version officielle

jobs:
  deploy-api:
    runs-on: ubuntu-latest

    steps:
      # 1) Récupérer le code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2) Télécharger le modèle entraîné (artifact du CI)
      - name: Télécharger le modèle du CI
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: models/

      # 3) Connexion au registre Docker Hub
      - name: Connexion Docker Hub
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # 4) Build de l’image Docker
      - name: Construire image Docker API
        run: |
          IMAGE=${{ secrets.DOCKER_USERNAME }}/ml-api
          TAG=${GITHUB_REF#refs/tags/}   # exemple : v1.0.0
          docker build -t $IMAGE:latest -t $IMAGE:$TAG .

      # 5) Push vers Docker Hub
      - name: Push Docker image
        run: |
          IMAGE=${{ secrets.DOCKER_USERNAME }}/ml-api
          TAG=${GITHUB_REF#refs/tags/}
          docker push $IMAGE:latest
          docker push $IMAGE:$TAG

      # 6) Déclencher le déploiement Render (via deploy hook)
      - name: Déployer sur Render
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"
